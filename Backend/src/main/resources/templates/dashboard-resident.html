<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Residente</title>
</head>
<body>
<h2 id="greeting">Cargando...</h2>

<div>
    <h3>Información del Apartamento</h3>
    <p id="apartmentInfo">Cargando información...</p>
</div>

<hr>

<!-- 🔹 Tabla de visitantes -->
<div>
    <h2>Últimos Visitantes</h2>
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
        <tr>
            <th>Nombre</th>
            <th>Motivo</th>
            <th>Fecha de Ingreso</th>
        </tr>
        </thead>
        <tbody id="visitorTable">
        <tr><td colspan="3">Cargando visitantes...</td></tr>
        </tbody>
    </table>
</div>

<hr>

<!-- 🔹 Tabla de encomiendas -->
<div>
    <h3>Últimas Encomiendas</h3>
    <table border="1" id="packagesTable" style="width: 100%; border-collapse: collapse;">
        <thead>
        <tr>
            <th>Fecha de Recepción</th>
            <th>Descripción</th>
            <th>Estado</th>
        </tr>
        </thead>
        <tbody id="packagesBody">
        <tr><td colspan="3">Cargando encomiendas...</td></tr>
        </tbody>
    </table>
</div>

<hr>

<!-- 🔹 Comunicados -->
<div>
    <h3>Últimos Comunicados</h3>
    <ul id="noticesContainer">Cargando comunicados...</ul>
</div>

<button onclick="logout()">Cerrar sesión</button>

<script>
  async function loadDashboard() {
    const residentId = localStorage.getItem('residentId');
    const residentName = localStorage.getItem('residentName');
    const greetingElement = document.getElementById('greeting');
    const apartmentInfoElement = document.getElementById('apartmentInfo');

    if (!residentId) {
      window.location.href = '/view/login';
      return;
    }

    greetingElement.innerText = `Hola, ${residentName}`;

    try {
      const response = await fetch(`/resident/${residentId}`);
      if (!response.ok) {
        const errorText = await response.text();
        apartmentInfoElement.innerText = `Error ${response.status}: No se pudo cargar el dashboard.`;
        console.error("Error del servidor:", errorText);
        return;
      }

      const data = await response.json();

      // 🔹 Información del apartamento
      const apartment = data.apartment;
      let aptInfo = 'No se encontró información del apartamento.';
      if (apartment) {
        const towerNum = (apartment.tower && apartment.tower.number) ? apartment.tower.number : 'N/A';
        aptInfo = `Torre: ${towerNum}, Apartamento: ${apartment.number}`;
        localStorage.setItem("apartmentNumber", apartment.number); // Guardar número
      }
      apartmentInfoElement.innerText = aptInfo;

      // 🔹 Últimos visitantes
      if (apartment && apartment.number) {
        await cargarUltimosVisitantes(apartment.number);
      }

      // 🔹 Últimas encomiendas
      const packagesBody = document.getElementById('packagesBody');
      packagesBody.innerHTML = '';
      if (data.latestPackages && data.latestPackages.length > 0) {
        data.latestPackages.forEach(pkg => {
          const estado = pkg.status === 'RECEIVED' ? 'Por recoger' : 'Entregado';
          const fechaRecepcion = pkg.receivedAt ? pkg.receivedAt : '---';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${fechaRecepcion}</td>
            <td>${pkg.description}</td>
            <td>${estado}</td>
          `;
          packagesBody.appendChild(row);
        });
      } else {
        packagesBody.innerHTML = `<tr><td colspan="3">No hay encomiendas recientes.</td></tr>`;
      }

      // 🔹 Comunicados
      renderList(
        'noticesContainer',
        data.latestNotices,
        notice => `<h4>${notice.title}</h4><p>${notice.content}</p>`,
        'No hay comunicados recientes.'
      );

    } catch (error) {
      apartmentInfoElement.innerText = 'Error al conectar con el servidor.';
      console.error("Error de conexión/parseo:", error);
    }
  }

  // Carga correcta de visitantes
  async function cargarUltimosVisitantes(apartmentNumber) {
    try {
      const response = await fetch(`/celador/find-visitors-apartment/${apartmentNumber}`);
      if (!response.ok) {
        console.error("Error al cargar visitantes:", response.statusText);
        return;
      }

      const data = await response.json();
      const tableBody = document.getElementById("visitorTable");
      tableBody.innerHTML = "";

      if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="3">No hay visitantes registrados.</td></tr>`;
        return;
      }

      data.forEach(visitor => {
        const fechaIngreso = visitor.entryTime
          ? new Date(visitor.entryTime).toLocaleString("es-CO")
          : "---";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${visitor.name}</td>
          <td>${visitor.reason}</td>
          <td>${fechaIngreso}</td>
        `;
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error("Error al cargar visitantes:", error);
    }
  }

  function renderList(containerId, items, itemMapper, emptyMessage) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (items && items.length > 0) {
      items.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = itemMapper(item);
        container.appendChild(li);
      });
    } else {
      container.innerHTML = `<p>${emptyMessage}</p>`;
    }
  }

  function logout() {
    localStorage.clear();
    window.location.href = '/view/login';
  }

  document.addEventListener("DOMContentLoaded", loadDashboard);
</script>

</body>
</html>
